---
import Basic from "../templates/basic.astro";
import Minimal from "../templates/minimal.astro";
import Modern from "../templates/modern.astro";

const { slug } = Astro.params;
const API_URL = `${import.meta.env.PUBLIC_NOETICS_CMS_API_URL}/posts/${slug}`;
const CMS_TOKEN = import.meta.env.PUBLIC_DG_CMS_TOKEN;

let post = null;
let error = null;
let template = Basic; // Default template (must be a component)

try {
    const res = await fetch(API_URL, {
        headers: {
            Authorization: `Bearer ${CMS_TOKEN}`,
            Accept: "application/json",
        },
    });

    if (!res.ok) throw new Error(`Failed to fetch post: ${res.statusText}`);
    post = await res.json();

    // Determine which template to use
    const availableTemplates = {
        basic: Basic,
        minimal: Minimal,
        modern: Modern,
    };
    template = availableTemplates[post?.template] || Basic;
} catch (err) {
    console.error("Error fetching blog post:", err);
    error = "Failed to load blog post. Please try again later.";
}
---

{
    error ? (
        <p class="text-red-500">{error}</p>
    ) : post ? (
        <component is={template} post={post} />
    ) : (
        <p>Post not found.</p>
    )
}
