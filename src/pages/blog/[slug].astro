---
import Basic from "../templates/basic.astro";
import Minimal from "../templates/minimal.astro";
import Modern from "../templates/modern.astro";

const { slug } = Astro.params;
const API_URL = `${import.meta.env.PUBLIC_NOETICS_CMS_API_URL}/posts/${slug}`;
const CMS_TOKEN = import.meta.env.PUBLIC_DG_CMS_TOKEN;

let post = null;
let error = null;
let TemplateComponent = Basic; // Default template

try {
    const res = await fetch(API_URL, {
        headers: {
            Authorization: `Bearer ${CMS_TOKEN}`,
            Accept: "application/json",
        },
    });

    if (!res.ok) throw new Error(`Failed to fetch post: ${res.statusText}`);
    post = await res.json();

    // Determine the correct template
    const templates = {
        basic: Basic,
        minimal: Minimal,
        modern: Modern,
    };

    if (post?.template && templates[post.template]) {
        TemplateComponent = templates[post.template];
    }
} catch (err) {
    console.error("Error fetching blog post:", err);
    error = "Failed to load blog post. Please try again later.";
}
---

{
    error ? (
        <p class="text-red-500">{error}</p>
    ) : post ? (
        <TemplateComponent post={post} />
    ) : (
        <p>Post not found.</p>
    )
}
